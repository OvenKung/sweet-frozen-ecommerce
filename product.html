<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏° ‚Äî Sweet Frozen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'pastel-pink': '#ffb3ba',
            'pastel-peach': '#ffdfba',
            'pastel-yellow': '#ffffba',
            'pastel-green': '#baffc9',
            'pastel-blue': '#bae1ff',
            'pastel-purple': '#e1baff',
            'pastel-lavender': '#f0e6ff',
            'primary': '#ff8fab',
            'primary-hover': '#ff6b9d',
            'secondary': '#c8e6c9',
            'accent': '#b39ddb',
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'slide-in-up': 'slideInUp 0.8s ease-out',
            'slide-in-left': 'slideInLeft 0.8s ease-out',
            'bounce-in': 'bounceIn 0.8s ease-out',
            'sparkle': 'sparkle 2s ease-in-out infinite',
            'wobble': 'wobble 0.5s ease-in-out'
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0px) rotate(0deg)' },
              '50%': { transform: 'translateY(-10px) rotate(2deg)' }
            },
            slideInUp: {
              from: { opacity: '0', transform: 'translateY(30px)' },
              to: { opacity: '1', transform: 'translateY(0)' }
            },
            slideInLeft: {
              from: { opacity: '0', transform: 'translateX(-30px)' },
              to: { opacity: '1', transform: 'translateX(0)' }
            },
            bounceIn: {
              '0%': { opacity: '0', transform: 'scale(0.3)' },
              '50%': { opacity: '1', transform: 'scale(1.05)' },
              '100%': { opacity: '1', transform: 'scale(1)' }
            },
            sparkle: {
              '0%, 100%': { opacity: '1', transform: 'scale(1) rotate(0deg)' },
              '50%': { opacity: '0.7', transform: 'scale(1.2) rotate(180deg)' }
            },
            wobble: {
              '0%, 100%': { transform: 'rotate(0deg)' },
              '25%': { transform: 'rotate(-3deg)' },
              '75%': { transform: 'rotate(3deg)' }
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="./assets/css/styles.css"/>
  <script type="module" src="./assets/js/app.js"></script>
</head>
<body>
  <div id="app-header"></div>
  
  <!-- Breadcrumb -->
  <nav class="max-w-6xl mx-auto px-2 sm:px-4 lg:px-6 py-2">
    <div class="flex items-center space-x-1 sm:space-x-2 text-xs sm:text-sm overflow-x-auto whitespace-nowrap pb-2">
      <a href="./index.html" class="text-primary hover:text-primary-hover transition-colors flex-shrink-0">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
      <span class="text-gray-400 flex-shrink-0">‚Ä∫</span>
      <span class="text-gray-600 flex-shrink-0" id="breadcrumb-category">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      <span class="text-gray-400 flex-shrink-0">‚Ä∫</span>
      <span class="text-gray-800 font-medium truncate" id="breadcrumb-product">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-2 sm:px-4 lg:px-6 py-4" id="content"></main>
  <div id="app-footer"></div>
  <script type="module">
    import { getProduct, PRODUCTS, loadIceCreamProducts } from './assets/js/products.js';
    import { Cart } from './assets/js/cart.js';
    import { toast, updateHeader } from './assets/js/ui.js';
    import { 
      loadReviews, 
      getProductReviews, 
      getProductRating, 
      getProductReviewStats,
      addReview,
      markReviewHelpful,
      generateStarRating,
      generateInteractiveStarRating,
      formatRelativeTime 
    } from './assets/js/reviews.js';
    import { currentUser } from './assets/js/auth.js';

    document.addEventListener('DOMContentLoaded', function() {
        // Update navbar to show current user state
        setTimeout(() => {
            updateHeader();
        }, 100);
    });

    function renderProduct() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      const p = getProduct(id);
      const c = document.getElementById('content');

      if(!p){ 
        c.innerHTML = '<div class="alert error">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ üòî</div>'; 
      }
      else{
        const allergensList = p.allergens && p.allergens.length > 0 
          ? p.allergens.join(', ') 
          : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
          
        const ingredientsList = p.ingredients && p.ingredients.length > 0 
          ? p.ingredients.join(', ') 
          : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

        // Get review data
        const reviewStats = getProductReviewStats(p.id);
        const reviews = getProductReviews(p.id);
        const currentUserData = currentUser();
        const userHasReviewed = currentUserData && reviews.some(r => r.userId === currentUserData.id);
          
        c.innerHTML = `
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 sm:mb-8">
            <div>
              <img src="${p.image}" alt="${p.name}" class="w-full rounded-2xl sm:rounded-3xl border-2 sm:border-4 border-pastel-pink shadow-xl"/>
            </div>
            <div class="bg-gradient-to-br from-white to-blue-50 p-4 sm:p-6 lg:p-8 rounded-2xl sm:rounded-3xl border-2 border-pastel-blue shadow-xl">
              <h2 class="text-2xl sm:text-3xl lg:text-4xl font-black text-primary mb-3 sm:mb-4">üç¶ ${p.name}</h2>
              <div class="bg-pastel-peach px-3 sm:px-4 py-2 rounded-xl sm:rounded-2xl text-xs sm:text-sm inline-block mb-3 sm:mb-4">üè∑Ô∏è ‡∏´‡∏°‡∏ß‡∏î: ${p.category}</div>
              
              <!-- Rating Section -->
              <div class="flex items-center gap-3 mb-4 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                <div class="flex items-center">
                  ${generateStarRating(reviewStats.averageRating)}
                </div>
                <span class="text-lg font-bold text-gray-700">${reviewStats.averageRating}</span>
                <span class="text-sm text-gray-600">(${reviewStats.totalReviews} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</span>
              </div>
              
              <p class="text-lg leading-relaxed text-purple-700 mb-6">${p.description}</p>
              
              <div class="bg-gradient-to-r from-pastel-lavender to-pastel-blue p-6 rounded-2xl mb-6 border-2 border-pastel-purple">
                <div class="text-sm mb-2"><strong>üìã ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°:</strong> ${ingredientsList}</div>
                <div class="text-sm mb-2"><strong>‚ö†Ô∏è ‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏û‡πâ:</strong> ${allergensList}</div>
                ${p.calories ? `<div class="text-sm mb-2"><strong>üî• ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà:</strong> ${p.calories} kcal</div>` : ''}
                <div class="text-sm"><strong>üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong> <span class="text-primary font-bold">${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô</span></div>
              </div>
              
              <div class="text-5xl font-black text-center text-primary mb-8 drop-shadow-lg">
                ‡∏ø${p.price.toLocaleString()}
              </div>
              
              <!-- Action Buttons -->
              <div class="space-y-4">
                <!-- Add to Cart Section -->
                <div class="flex gap-3 items-center bg-pastel-yellow p-4 rounded-2xl">
                  <label class="font-bold text-purple-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                  <input id="qty" type="number" min="1" max="${p.stock}" value="1" class="w-20 text-center font-bold py-2 px-3 border-2 border-pastel-blue rounded-xl"/>
                  <button id="addBtn" class="flex-1 bg-gradient-to-r from-primary to-primary-hover text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:shadow-lg hover:-translate-y-1">üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                </div>
                
                <!-- Favorite Button -->
                <button id="favoriteBtn" class="w-full bg-gradient-to-r from-red-400 to-pink-500 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:shadow-lg hover:-translate-y-1 flex items-center justify-center space-x-2">
                  <span id="favoriteIcon">‚ù§Ô∏è</span>
                  <span id="favoriteText">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Reviews Section -->
          <div class="bg-gradient-to-br from-white to-purple-50 rounded-3xl border-2 border-pastel-blue shadow-xl p-8">
            <h3 class="text-2xl font-bold text-primary mb-6 flex items-center">
              ‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
              <span class="text-lg font-normal text-gray-600 ml-2">(${reviewStats.totalReviews} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</span>
            </h3>

            <!-- Review Summary -->
            ${reviewStats.totalReviews > 0 ? `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="text-center">
                  <div class="text-4xl font-black text-primary mb-2">${reviewStats.averageRating}</div>
                  <div class="flex justify-center mb-2">
                    ${generateStarRating(reviewStats.averageRating, 'text-xl')}
                  </div>
                  <div class="text-gray-600">‡∏à‡∏≤‡∏Å ${reviewStats.totalReviews} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
                </div>
                <div class="space-y-2">
                  ${[5,4,3,2,1].map(star => {
                    const count = reviewStats.ratingDistribution[star];
                    const percentage = reviewStats.totalReviews > 0 ? (count / reviewStats.totalReviews * 100) : 0;
                    return `
                      <div class="flex items-center gap-2">
                        <span class="text-sm w-3">${star}</span>
                        <span class="text-yellow-400">‚≠ê</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                          <div class="bg-yellow-400 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <span class="text-sm text-gray-600 w-8">${count}</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Write Review Form -->
            ${currentUserData && !userHasReviewed ? `
              <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                <h4 class="text-lg font-bold text-primary mb-4">‚úçÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
                <form id="reviewForm" class="space-y-4">
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
                    ${generateInteractiveStarRating()}
                  </div>
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                    <input type="text" name="title" required maxlength="100" 
                           class="w-full px-4 py-2 border-2 border-blue-200 rounded-xl focus:border-primary focus:outline-none"
                           placeholder="‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                  </div>
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</label>
                    <textarea name="comment" required maxlength="500" rows="4"
                              class="w-full px-4 py-2 border-2 border-blue-200 rounded-xl focus:border-primary focus:outline-none"
                              placeholder="‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ..."></textarea>
                  </div>
                  <button type="submit" class="bg-gradient-to-r from-primary to-primary-hover text-white font-bold py-3 px-6 rounded-xl hover:shadow-lg transition-all">
                    üìù ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                  </button>
                </form>
              </div>
            ` : currentUserData && userHasReviewed ? `
              <div class="bg-green-50 border-2 border-green-200 rounded-2xl p-4 mb-6 text-center">
                <div class="text-green-700">‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
              </div>
            ` : `
              <div class="bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 mb-6 text-center">
                <div class="text-gray-600">
                  <a href="./login.html" class="text-primary font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a> 
                  ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                </div>
              </div>
            `}

            <!-- Reviews List -->
            <div class="space-y-4" id="reviewsList">
              ${reviews.length === 0 ? `
                <div class="text-center py-8 text-gray-500">
                  <div class="text-4xl mb-4">ü§î</div>
                  <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ</div>
                  <div class="text-sm">‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏¥!</div>
                </div>
              ` : reviews.map(review => `
                <div class="bg-white border-2 border-gray-100 rounded-2xl p-6 shadow-sm hover:shadow-md transition-shadow">
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 bg-gradient-to-r from-primary to-accent rounded-full flex items-center justify-center text-white font-bold">
                        ${review.userName.charAt(0)}
                      </div>
                      <div>
                        <div class="font-bold text-gray-800">${review.userName}</div>
                        <div class="text-sm text-gray-500">${formatRelativeTime(review.date)}</div>
                      </div>
                      ${review.verified ? '<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2">
                      ${generateStarRating(review.rating, 'text-sm')}
                    </div>
                  </div>
                  
                  <h5 class="font-bold text-gray-800 mb-2">${review.title}</h5>
                  <p class="text-gray-700 mb-4 leading-relaxed">${review.comment}</p>
                  
                  <div class="flex items-center justify-between text-sm">
                    <button onclick="markHelpful('${review.id}')" 
                            class="text-gray-500 hover:text-primary transition-colors flex items-center gap-1">
                      üëç ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (${review.helpful || 0})
                    </button>
                    <div class="text-gray-400">${review.date}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        
        // Add event listeners
        const addBtn = document.getElementById('addBtn');
        if (addBtn) {
          addBtn.addEventListener('click', ()=>{
            const q = Math.max(1, parseInt(document.getElementById('qty').value||'1',10));
            Cart.add(p.id, q);
            document.getElementById('cartCount').textContent = Cart.count();
            toast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${p.name} ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üç¶`);
          });
        }

        // Favorite button handler
        const favoriteBtn = document.getElementById('favoriteBtn');
        const favoriteIcon = document.getElementById('favoriteIcon');
        const favoriteText = document.getElementById('favoriteText');
        
        if (favoriteBtn && favoriteIcon && favoriteText) {
          // Initialize favorite button state
          const user = currentUser();
          updateFavoriteButton(user, p.id);
          
          favoriteBtn.addEventListener('click', () => {
            const user = currentUser();
            if (!user) {
              toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î', 'error');
              setTimeout(() => {
                window.location.href = './login.html';
              }, 1500);
              return;
            }

            // Initialize favorites array if it doesn't exist
            if (!user.favoriteProducts) {
              user.favoriteProducts = [];
            }

            const isFavorite = user.favoriteProducts.includes(p.id);
            
            if (isFavorite) {
              // Remove from favorites
              user.favoriteProducts = user.favoriteProducts.filter(id => id !== p.id);
              toast(`üíî ‡∏•‡∏ö "${p.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏•‡πâ‡∏ß`, 'info');
            } else {
              // Add to favorites
              user.favoriteProducts.push(p.id);
              toast(`‚ù§Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° "${p.name}" ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
            }

            // Save to localStorage
            try {
              const users = JSON.parse(localStorage.getItem('app.users') || '[]');
              const userIndex = users.findIndex(u => u.email === user.email);
              if (userIndex !== -1) {
                users[userIndex] = user;
                localStorage.setItem('app.users', JSON.stringify(users));
                localStorage.setItem('app.auth.current.v1', JSON.stringify(user));
              }
            } catch (error) {
              console.error('Error saving favorites:', error);
              toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
              return;
            }

            // Update button appearance
            updateFavoriteButton(user, p.id);
          });
        }

        // Function to update favorite button appearance
        function updateFavoriteButton(user, productId) {
          if (!user || !favoriteBtn || !favoriteIcon || !favoriteText) return;
          
          const isFavorite = user.favoriteProducts && user.favoriteProducts.includes(productId);
          
          if (isFavorite) {
            favoriteBtn.className = 'w-full bg-gradient-to-r from-gray-400 to-gray-500 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:shadow-lg hover:-translate-y-1 flex items-center justify-center space-x-2';
            favoriteIcon.textContent = 'üíî';
            favoriteText.textContent = '‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î';
          } else {
            favoriteBtn.className = 'w-full bg-gradient-to-r from-red-400 to-pink-500 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:shadow-lg hover:-translate-y-1 flex items-center justify-center space-x-2';
            favoriteIcon.textContent = '‚ù§Ô∏è';
            favoriteText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î';
          }
        }

        // Review form handler
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
          reviewForm.addEventListener('submit', handleReviewSubmit);
        }
      }
    }
    
    // Render immediately with available data
    renderProduct();
    
    // Load full data from JSON and re-render
    // Handle review form submission
    async function handleReviewSubmit(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const rating = parseInt(formData.get('rating'));
      const title = formData.get('title');
      const comment = formData.get('comment');

      if (!rating || rating < 1 || rating > 5) {
        toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1-5 ‡∏î‡∏≤‡∏ß', 'error');
        return;
      }

      if (!title.trim()) {
        toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß', 'error');
        return;
      }

      if (!comment.trim()) {
        toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô', 'error');
        return;
      }

      try {
        const params = new URLSearchParams(location.search);
        const productId = params.get('id');
        
        addReview(productId, rating, title, comment);
        toast('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô üôè', 'success');
        
        // Refresh the product page to show new review
        setTimeout(() => {
          renderProduct();
        }, 1000);
        
      } catch (error) {
        toast(error.message, 'error');
      }
    }

    // Mark review as helpful
    window.markHelpful = function(reviewId) {
      const newCount = markReviewHelpful(reviewId);
      toast('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô! üëç');
      
      // Update the display
      const button = document.querySelector(`button[onclick="markHelpful('${reviewId}')"]`);
      if (button) {
        button.innerHTML = `üëç ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (${newCount})`;
      }
    };

    // Wait for products to load, then render
    async function init() {
      await loadIceCreamProducts();
      await loadReviews();
      renderProduct();
    }

    init();
  </script>
</body>
</html>
